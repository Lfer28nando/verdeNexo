<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Perfil - Vivero Verde Nexo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/perfil.styles.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script type="module" src="/js/api.functions.js"></script>
    <script type="module" src="/js/perfil.functions.js"></script>

</head>

<body>
    <!-- NAVBAR (DESKTOP)-->
    <nav class="navbar navbar-expand-lg navbar-vn sticky-top d-none d-lg-flex">
        <div class="container-fluid px-4 align-items-center">
            <!-- Secciones -->
            <div class="collapse navbar-collapse order-1 order-lg-0" id="navbar-vn-1" style="flex: 1;">
                <ul class="navbar-nav mb-3 mb-lg-0">
                    <li class="nav-item"><a class="nav-link navbar-vn-links" href="/">Inicio</a></li>
                    <li class="nav-item"><a class="nav-link navbar-vn-links" href="/catalogo">Catálogo</a></li>
                    <li class="nav-item"><a class="nav-link navbar-vn-links" href="/servicios">Servicios</a></li>
                    <li class="nav-item"><a class="nav-link navbar-vn-links" href="/blog">Blog</a></li>
                    <li class="nav-item"><a class="nav-link navbar-vn-links" href="/contacto">Contacto</a></li>
                </ul>
            </div>

            <!--Logo -->
            <div class="text-center order-0" style="flex: 1;">
                <a href="/"><img src="/img/logo.png" alt="Verde Nexo" height="45"></a>
            </div>

            <!--Buscador + botones -->
            <!---Buscador-->
            <div class="d-flex align-items-center justify-content-end order-2" style="flex: 1; gap: 0.75rem;">
                <form class="d-none d-lg-flex" role="search" style="min-width: 200px;">
                    <div class="input-group">
                        <span class="input-group-text">
                            <img src="/img/search-alt.png" alt="Buscar" width="16" height="16">
                        </span>
                        <input class="form-control" type="search" placeholder="Buscar..." aria-label="Buscar">
                    </div>
                </form>
                <!-- Botones de logout -->
                <div class="d-flex" style="gap: 0.5rem;">
                    <button id="logoutBtn" class="btn btn-vn-session" type="button">
                        <i class="fas fa-sign-out-alt" style="font-size: 20px;"></i>
                    </button>
                    <!-- Carrito de compras -->
                    <button class="btn btn-vn-session position-relative" aria-expanded="false" type="button">
                        <img src="/img/shopping-cart-alt.png" alt="carrito" width="20" height="20">
                        <span class="badge bg-danger position-absolute top-0 start-100 translate-middle rounded-pill">0</span>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- NAVBAR (MOBILE)-->
    <header class="d-lg-none py-3">
        <div class="container d-flex justify-content-between align-items-center">
            <!-- logo centrado -->
            <div class="flex-fill text-start">
                <!--icono izquierdo vacío para centrar mejor -->
            </div>
            <div class="flex-fill text-center">
                <a href="/"><img src="/img/logo.png" alt="Verde Nexo" height="40"></a>
            </div>
            <div class="flex-fill text-end">
                <button id="logoutBtnMobile" class="btn btn-outline-danger btn-sm">
                    <i class="fas fa-sign-out-alt me-2"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- BOTTOM NAV para mobile -->
    <nav class="bottom-nav d-lg-none">
        <a href="/" class="bottom-nav-item">
            <img src="/img/icon-home.svg" alt="Home" width="22" height="22" class="icon-white"><span>Inicio</span>
        </a>
        <a href="/catalogo" class="bottom-nav-item">
            <img src="/img/icon-search.svg" alt="Buscar" width="22" height="22" class="icon-white"><span>Buscar</span>
        </a>
        <a href="/favoritos" class="bottom-nav-item">
            <img src="/img/icon-heart.svg" alt="Favoritos" width="22" height="22" class="icon-white"><span>Favoritos</span>
        </a>
        <a href="/perfil" class="bottom-nav-item active">
            <img src="/img/icon-user.svg" alt="Perfil" width="22" height="22" class="icon-white"><span>Perfil</span>
        </a>
    </nav>

    <!-- Header del Perfil -->
    <section class="profile-header">
        <div class="container">
            <div class="row justify-content-center text-center">
                <div class="col-md-8">
                    <img src="https://pic.onlinewebfonts.com/thumbnails/icons_281692.svg" alt="Avatar" class="profile-avatar mb-4">
                    <div class="profile-welcome">
                        <h1 id="welcomeName">Bienvenido</h1>
                        <p id="welcomeEmail">Cargando información...</p>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Contenido Principal -->
    <div class="container my-5">
        <div class="row justify-content-center">
            <div class="col-lg-10">
                <!-- Navegación de Secciones -->
                <ul class="nav nav-pills profile-nav mb-4" id="profileTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="info-tab" data-bs-toggle="pill" data-bs-target="#info" type="button" role="tab">Información</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="security-tab" data-bs-toggle="pill" data-bs-target="#security" type="button" role="tab">Seguridad</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="preferences-tab" data-bs-toggle="pill" data-bs-target="#preferences" type="button" role="tab">Preferencias</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="favorites-tab" data-bs-toggle="pill" data-bs-target="#favorites" type="button" role="tab">Favoritos</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="orders-tab" data-bs-toggle="pill" data-bs-target="#orders" type="button" role="tab">Pedidos</button>
                    </li>
                </ul>

                <!-- Contenido de las Secciones -->
                <div class="tab-content" id="profileTabContent">
                    <!-- Información Personal -->
                    <div class="tab-pane fade show active" id="info" role="tabpanel">
                        <div class="profile-section">
                            <div class="section-header">
                                <h3><i class="fas fa-user me-2"></i>Información Personal</h3>
                                <p>Administra tu información de cuenta</p>
                            </div>
                            <div id="personalInfo">
                                <div class="loading">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Seguridad -->
                    <div class="tab-pane fade" id="security" role="tabpanel">
                        <div class="profile-section">
                            <div class="section-header">
                                <h3><i class="fas fa-shield-alt me-2"></i>Seguridad de la Cuenta</h3>
                                <p>Protege tu cuenta con medidas de seguridad avanzadas</p>
                            </div>
                            <div id="securityContent">
                                <div class="loading">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Preferencias -->
                    <div class="tab-pane fade" id="preferences" role="tabpanel">
                        <div class="profile-section">
                            <div class="section-header">
                                <h3><i class="fas fa-cog me-2"></i>Preferencias</h3>
                                <p>Personaliza tu experiencia en Verde Nexo</p>
                            </div>
                            <div id="preferencesContent">
                                <div class="setting-item">
                                    <div>
                                        <span class="setting-label">Notificaciones por email</span>
                                        <p class="text-muted mb-0">Recibe actualizaciones sobre tus pedidos</p>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div>
                                        <span class="setting-label">Recordatorios de riego</span>
                                        <p class="text-muted mb-0">Recibe consejos de cuidado para tus plantas</p>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="wateringReminders" checked>
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div>
                                        <span class="setting-label">Ofertas especiales</span>
                                        <p class="text-muted mb-0">Descuentos y promociones exclusivas</p>
                                    </div>
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="specialOffers">
                                    </div>
                                </div>
                                <div class="setting-item">
                                    <div>
                                        <span class="setting-label">Idioma</span>
                                        <p class="text-muted mb-0">Selecciona tu idioma preferido</p>
                                    </div>
                                    <select class="form-select w-auto">
                                        <option value="es" selected>Español</option>
                                        <option value="en">English</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Favoritos -->
                    <div class="tab-pane fade" id="favorites" role="tabpanel">
                        <div class="profile-section">
                            <div class="section-header">
                                <h3><i class="fas fa-heart me-2"></i>Mis Favoritos</h3>
                                <p>Productos que has marcado como favoritos</p>
                            </div>
                            <div id="favoritesList">
                                <div class="loading">
                                    <div class="spinner-border" role="status">
                                        <span class="visually-hidden">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pedidos -->
                    <div class="tab-pane fade" id="orders" role="tabpanel">
                        <div class="profile-section">
                            <div class="section-header">
                                <h3><i class="fas fa-shopping-bag me-2"></i>Mis Pedidos</h3>
                                <p>Historial de tus compras y pedidos realizados</p>
                            </div>
                            <div id="ordersList">
                                <div class="text-center py-5">
                                    <i class="fas fa-shopping-cart fa-3x text-muted mb-3"></i>
                                    <h5 class="text-muted">No tienes pedidos aún</h5>
                                    <p class="text-muted">Cuando realices tu primera compra, aparecerá aquí.</p>
                                    <a href="/" class="btn btn-success">
                                        <i class="fas fa-store me-2"></i>Ir a la tienda
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar perfil -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">Editar Perfil</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editProfileForm">
                        <div class="mb-3">
                            <label for="editUsername" class="form-label">Nombre de usuario *</label>
                            <input type="text" class="form-control" id="editUsername" required>
                            <div class="form-text">Tu nombre de usuario público</div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="editDocumentType" class="form-label">Tipo de documento</label>
                                <select class="form-select" id="editDocumentType">
                                    <option value="">Seleccionar...</option>
                                    <option value="Cédula">Cédula</option>
                                    <option value="Cédula de extranjería">Cédula de extranjería</option>
                                    <option value="PPT">PPT</option>
                                    <option value="Pasaporte">Pasaporte</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="editDocument" class="form-label">Número de documento</label>
                                <input type="text" class="form-control" id="editDocument" placeholder="Ej: 12345678">
                                <div class="form-text">Solo números y letras</div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="editCellphone" class="form-label">Teléfono celular</label>
                            <input type="tel" class="form-control" id="editCellphone" placeholder="Ej: +5491123456789">
                            <div class="form-text">Incluye código de país (+54 para Argentina)</div>
                        </div>

                        <div class="mb-3">
                            <label for="editAddress" class="form-label">Dirección</label>
                            <textarea class="form-control" id="editAddress" rows="3" placeholder="Ej: Calle 123, Ciudad, Provincia"></textarea>
                            <div class="form-text">Dirección completa para entregas</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="saveProfile()">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para configurar 2FA -->
    <div class="modal fade" id="setup2FAModal" tabindex="-1" aria-labelledby="setup2FAModalLabel">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="setup2FAModalLabel">Configurar Autenticación de Dos Factores</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <h6>Escanea este código QR con tu app autenticadora</h6>
                        <div id="qrCodeContainer" class="mb-3"></div>
                        <small class="text-muted">O ingresa manualmente: <code id="secretCode"></code></small>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>Códigos de respaldo:</strong> Guarda estos códigos en un lugar seguro. Los necesitarás si pierdes acceso a tu app autenticadora.
                        <div id="backupCodesContainer" class="mt-2 p-2 bg-light rounded">
                            <!-- Códigos se mostrarán aquí -->
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="twoFactorCode" class="form-label">Ingresa el código de 6 dígitos de tu app:</label>
                        <input type="text" class="form-control text-center" id="twoFactorCode" maxlength="6" placeholder="000000">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="verifyAndEnable2FA()">Activar 2FA</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cambiar email -->
    <div class="modal fade" id="changeEmailModal" tabindex="-1" aria-labelledby="changeEmailModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changeEmailModalLabel">Confirmar Cambio de Email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-envelope me-2"></i>
                        Se envió un código de confirmación a <strong id="newEmailDisplay"></strong>
                    </div>
                    
                    <div class="mb-3">
                        <label for="emailChangeCode" class="form-label">Ingresa el código de 6 dígitos:</label>
                        <input type="text" class="form-control text-center" id="emailChangeCode" maxlength="6" placeholder="000000">
                    </div>
                    
                    <small class="text-muted">
                        El código expira en 1 hora. Si no lo recibiste, verifica tu carpeta de spam.
                    </small>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="confirmEmailChange()">Confirmar Cambio</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cambiar contraseña -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changePasswordModalLabel">Cambiar Contraseña</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changePasswordForm">
                        <div class="mb-3">
                            <label for="currentPassword" class="form-label">Contraseña actual *</label>
                            <input type="password" class="form-control" id="currentPassword" required>
                        </div>
                        <div class="mb-3">
                            <label for="newPassword" class="form-label">Nueva contraseña *</label>
                            <input type="password" class="form-control" id="newPassword" required>
                            <div class="form-text">Mínimo 6 caracteres</div>
                        </div>
                        <div class="mb-3">
                            <label for="confirmPassword" class="form-label">Confirmar nueva contraseña *</label>
                            <input type="password" class="form-control" id="confirmPassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="submitChangePassword()">Cambiar Contraseña</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para desactivar 2FA -->
    <div class="modal fade" id="disable2FAModal" tabindex="-1" aria-labelledby="disable2FAModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="disable2FAModalLabel">Desactivar Autenticación de Dos Factores</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Advertencia:</strong> Desactivar la autenticación de dos factores reducirá la seguridad de tu cuenta.
                    </div>
                    <p>Para confirmar, ingresa tu contraseña actual:</p>
                    <div class="mb-3">
                        <label for="disable2FAPassword" class="form-label">Contraseña actual *</label>
                        <input type="password" class="form-control" id="disable2FAPassword" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-danger" onclick="submitDisable2FA()">Desactivar 2FA</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para cambiar email -->
    <div class="modal fade" id="changeEmailRequestModal" tabindex="-1" aria-labelledby="changeEmailRequestModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="changeEmailRequestModalLabel">Cambiar Dirección de Email</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="changeEmailForm">
                        <div class="mb-3">
                            <label for="newEmail" class="form-label">Nueva dirección de email *</label>
                            <input type="email" class="form-control" id="newEmail" required>
                            <div class="form-text">Se enviará un código de confirmación a esta dirección</div>
                        </div>
                        <div class="mb-3">
                            <label for="emailChangePassword" class="form-label">Contraseña actual *</label>
                            <input type="password" class="form-control" id="emailChangePassword" required>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" onclick="submitChangeEmailRequest()">Enviar Código</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para darse de baja -->
    <div class="modal fade" id="unsubscribeModal" tabindex="-1" aria-labelledby="unsubscribeModalLabel">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="unsubscribeModalLabel">
                        <i class="fas fa-exclamation-triangle me-2"></i>Eliminar Cuenta
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-danger">
                        <strong>¡Advertencia!</strong> Esta acción es irreversible. Se eliminarán permanentemente:
                        <ul class="mb-0 mt-2">
                            <li>Tu cuenta de usuario</li>
                            <li>Todos tus datos personales</li>
                            <li>Tu historial de pedidos</li>
                            <li>Tus productos favoritos</li>
                            <li>Todas tus configuraciones</li>
                        </ul>
                    </div>

                    <p class="text-muted mb-3">
                        Si estás seguro de que quieres continuar, ingresa tu contraseña actual para confirmar.
                    </p>

                    <form id="unsubscribeForm">
                        <div class="mb-3">
                            <label for="unsubscribePassword" class="form-label">
                                <strong>Contraseña actual *</strong>
                            </label>
                            <input type="password" class="form-control" id="unsubscribePassword" required
                                   placeholder="Ingresa tu contraseña">
                            <div class="form-text">Esta acción no se puede deshacer.</div>
                        </div>

                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="confirmDelete" required>
                            <label class="form-check-label" for="confirmDelete">
                                Entiendo que esta acción es permanente y no se puede deshacer.
                            </label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="submitUnsubscribe()">
                        <i class="fas fa-user-times me-1"></i>Eliminar mi cuenta
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para confirmar éxito -->
    <div class="modal fade" id="successModal" tabindex="-1" aria-labelledby="successModalLabel">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center p-4">
                    <img src="https://pic.onlinewebfonts.com/thumbnails/icons_561986.svg" alt="Check" width="80" height="80" class="mb-3">
                    <h5 class="modal-title text-success mb-3" id="successModalLabel">¡Perfil actualizado correctamente!</h5>
                    <p class="text-muted mb-0">Los cambios se han guardado exitosamente.</p>
                </div>
                <div class="modal-footer justify-content-center border-0">
                    <button type="button" class="btn btn-success" data-bs-dismiss="modal">Aceptar</button>
                </div>
            </div>
        </div>
    </div>

</body>

</html>

<%- include('../partials/footer') %>