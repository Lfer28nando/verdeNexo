<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Recuperar Contraseña - Verde Nexo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/styles.css">
    <script type="module" src="/js/api.functions.js"></script>
</head>
<body style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); min-height:100vh; color:#222;">
    <div class="container d-flex align-items-center justify-content-center" style="min-height:100vh;">
        <div class="card p-4 shadow-lg animate__animated animate__fadeInUp" style="max-width:420px; width:100%; background:#fff; color:#222; border-radius:22px; border:none;">
            <!-- Paso 1: Email -->
            <div id="stepEmail">
                <div class="text-center mb-4">
                    <img src="https://cdn-icons-png.flaticon.com/512/3064/3064197.png" alt="Candado" width="56" height="56">
                    <h2 class="fw-bold mt-2 mb-1" style="font-size:2rem; color:#198754;">Recuperar contraseña</h2>
                    <p class="text-muted mb-0">Ingresa tu correo electrónico y te enviaremos un código para restablecerla.</p>
                </div>
                <form id="requestResetForm" class="animate__animated animate__fadeIn">
                    <div class="mb-3 position-relative">
                        <span class="position-absolute top-50 start-0 translate-middle-y ps-3" style="color:#198754;">
                            <i class="fas fa-envelope"></i>
                        </span>
                        <input type="email" class="form-control form-control-lg ps-5" id="resetEmail" required placeholder="ejemplo@correo.com" style="border-radius:12px; border:1.5px solid #198754;">
                    </div>
                    <button type="submit" class="btn btn-success w-100 py-2 fw-bold" style="border-radius:12px;">Enviar código</button>
                </form>
                <div class="text-center mt-3">
                    <a href="/login" class="text-decoration-none" style="color:#198754;"><i class="fas fa-arrow-left me-2"></i>Volver al inicio de sesión</a>
                </div>
            </div>
            <!-- Paso 2: Código OTP -->
            <div id="stepCode" style="display:none;">
                <div class="text-center mb-4">
                    <img src="https://cdn-icons-png.flaticon.com/512/3064/3064198.png" alt="Verificación" width="56" height="56">
                    <h2 class="fw-bold mt-2 mb-1" style="font-size:1.6rem; color:#0d6efd;">Verifica tu código</h2>
                    <p class="text-muted mb-0">Ingresa el código de 6 dígitos que te enviamos por correo.</p>
                </div>
                <form id="codeForm" class="animate__animated animate__fadeIn">
                    <div class="d-flex justify-content-center gap-2 mb-3">
                        <input type="text" maxlength="1" class="form-control text-center otp-input" style="width:40px; font-size:1.5rem; border-radius:8px; border:1.5px solid #0d6efd;" required>
                        <input type="text" maxlength="1" class="form-control text-center otp-input" style="width:40px; font-size:1.5rem; border-radius:8px; border:1.5px solid #0d6efd;" required>
                        <input type="text" maxlength="1" class="form-control text-center otp-input" style="width:40px; font-size:1.5rem; border-radius:8px; border:1.5px solid #0d6efd;" required>
                        <input type="text" maxlength="1" class="form-control text-center otp-input" style="width:40px; font-size:1.5rem; border-radius:8px; border:1.5px solid #0d6efd;" required>
                        <input type="text" maxlength="1" class="form-control text-center otp-input" style="width:40px; font-size:1.5rem; border-radius:8px; border:1.5px solid #0d6efd;" required>
                        <input type="text" maxlength="1" class="form-control text-center otp-input" style="width:40px; font-size:1.5rem; border-radius:8px; border:1.5px solid #0d6efd;" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100 py-2 fw-bold" style="border-radius:12px;">Verificar código</button>
                </form>
                <div class="text-center mt-3">
                    <button id="resendCodeBtn" class="btn btn-link text-decoration-none" style="color:#0d6efd;">Reenviar código</button>
                </div>
            </div>
            <!-- Paso 3: Nueva contraseña -->
            <div id="stepPassword" style="display:none;">
                <div class="text-center mb-4">
                    <img src="https://cdn-icons-png.flaticon.com/512/3064/3064199.png" alt="Contraseña" width="56" height="56">
                    <h2 class="fw-bold mt-2 mb-1" style="font-size:1.6rem; color:#198754;">Nueva contraseña</h2>
                    <p class="text-muted mb-0">Elige una nueva contraseña segura para tu cuenta.</p>
                </div>
                <form id="resetPasswordForm" class="animate__animated animate__fadeIn">
                    <div class="mb-3">
                        <label for="newResetPassword" class="form-label">Nueva contraseña</label>
                        <input type="password" class="form-control form-control-lg" id="newResetPassword" required placeholder="Nueva contraseña" style="border-radius:12px; border:1.5px solid #198754;">
                    </div>
                    <div class="mb-3">
                        <label for="confirmResetPassword" class="form-label">Confirmar nueva contraseña</label>
                        <input type="password" class="form-control form-control-lg" id="confirmResetPassword" required placeholder="Repite la nueva contraseña" style="border-radius:12px; border:1.5px solid #198754;">
                    </div>
                    <button type="submit" class="btn btn-success w-100 py-2 fw-bold" style="border-radius:12px;">Cambiar contraseña</button>
                </form>
            </div>
            <div id="resetMsg" class="mt-3 text-center fw-bold" style="font-size:1.1rem;"></div>
        </div>
    </div>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // Usar instancia global API
        const API = window.API;
        let userEmail = '';
        let resetCode = '';
        // Paso 1: Solicitar código
        document.getElementById('requestResetForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('resetEmail').value.trim().toLowerCase();
            if (!email) return;
            try {
                const res = await API.post('/api/auth/requestPasswordReset', { email });
                document.getElementById('resetMsg').innerHTML = `<span class='text-success'><i class='fas fa-check-circle me-2'></i>${res.data.message || 'Código enviado. Revisa tu correo.'}</span>`;
                userEmail = email;
                document.getElementById('stepEmail').style.display = 'none';
                document.getElementById('stepCode').style.display = 'block';
            } catch (err) {
                document.getElementById('resetMsg').innerHTML = `<span class='text-danger'><i class='fas fa-times-circle me-2'></i>Error al enviar el código.</span>`;
            }
        });
        // Inputs OTP: avanzar automáticamente
        document.querySelectorAll('.otp-input').forEach((input, idx, arr) => {
            input.addEventListener('input', function() {
                if (this.value.length === 1 && idx < arr.length - 1) {
                    arr[idx + 1].focus();
                }
            });
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Backspace' && !this.value && idx > 0) {
                    arr[idx - 1].focus();
                }
            });
        });
        // Paso 2: Verificar código
        document.getElementById('codeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const code = Array.from(document.querySelectorAll('.otp-input')).map(i => i.value).join('');
            if (code.length !== 6) {
                document.getElementById('resetMsg').innerHTML = `<span class='text-danger'><i class='fas fa-exclamation-circle me-2'></i>Debes ingresar los 6 dígitos.</span>`;
                return;
            }
            resetCode = code;
            document.getElementById('stepCode').style.display = 'none';
            document.getElementById('stepPassword').style.display = 'block';
        });
        // Reenviar código
        document.getElementById('resendCodeBtn').addEventListener('click', async function() {
            if (!userEmail) return;
            try {
                const res = await API.post('/api/auth/requestPasswordReset', { email: userEmail });
                document.getElementById('resetMsg').innerHTML = `<span class='text-success'><i class='fas fa-check-circle me-2'></i>${res.data.message || 'Código reenviado.'}</span>`;
            } catch (err) {
                document.getElementById('resetMsg').innerHTML = `<span class='text-danger'><i class='fas fa-times-circle me-2'></i>Error al reenviar el código.</span>`;
            }
        });
        // Paso 3: Cambiar contraseña
        document.getElementById('resetPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const newPassword = document.getElementById('newResetPassword').value;
            const confirmPassword = document.getElementById('confirmResetPassword').value;
            if (!newPassword || !confirmPassword) return;
            if (newPassword.length < 6) {
                document.getElementById('resetMsg').innerHTML = `<span class='text-danger'><i class='fas fa-exclamation-circle me-2'></i>La contraseña debe tener al menos 6 caracteres.</span>`;
                return;
            }
            if (newPassword !== confirmPassword) {
                document.getElementById('resetMsg').innerHTML = `<span class='text-danger'><i class='fas fa-exclamation-circle me-2'></i>Las contraseñas no coinciden.</span>`;
                return;
            }
            try {
                const res = await API.post('/api/auth/resetPassword', {
                    email: userEmail,
                    code: resetCode,
                    newPassword
                });
                document.getElementById('resetMsg').innerHTML = `<span class='text-success'><i class='fas fa-check-circle me-2'></i>${res.data.message || 'Contraseña actualizada correctamente.'}</span>`;
                document.getElementById('stepPassword').style.display = 'none';
                setTimeout(() => {
                    window.location.href = '/';
                }, 1500);
            } catch (err) {
                document.getElementById('resetMsg').innerHTML = `<span class='text-danger'><i class='fas fa-times-circle me-2'></i>Error al cambiar la contraseña.</span>`;
            }
        });
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    </script>
</body>
</html>
